<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯æ—…éŠç®¡å®¶ (AI+DB+å”ä½œ)</title>
    <style>
        :root { --primary-color: #3f51b5; --secondary-color: #c62828; --accent-color: #007bff; }
        html, body { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; font-size: 16px; }
        .main-container { display: flex; height: calc(100% - 80px); }
        #itinerary-column { flex: 1; min-width: 360px; padding: 20px; background-color: #f8f9fa; overflow-y: auto; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; }
        #itinerary-header { padding-bottom: 10px; border-bottom: 2px solid var(--secondary-color); }
        #itinerary-header h2 { margin: 0; color: var(--secondary-color); }
        #trip-id-display { font-size: 0.8em; color: #6c757d; background: #e9ecef; padding: 2px 8px; border-radius: 5px; user-select: text; cursor: pointer; }
        #itinerary-list { list-style-type: none; padding: 0; margin-top: 15px; flex-grow: 1; }
        .itinerary-item { background-color: #fff; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.07); display: flex; align-items: center; gap: 10px; }
        .drag-handle { cursor: grab; color: #adb5bd; flex-shrink: 0; }
        .item-content { flex-grow: 1; }
        .item-title { font-weight: bold; font-size: 1.1em; color: var(--primary-color); }
        .item-time { font-size: 0.9em; color: #495057; font-weight: bold; }
        .item-actions button { background: none; border: none; cursor: pointer; color: #6c757d; font-size: 1.1em; padding: 5px; }
        .item-actions button:hover { color: #343a40; }
        .add-item-btn { width: 100%; padding: 10px; margin-top: 10px; background-color: #dbeafe; border: 2px dashed var(--accent-color); color: var(--accent-color); border-radius: 8px; cursor: pointer; font-weight: bold; }
        #map-column { flex: 2; } #map { height: 100%; width: 100%; }
        #day-selector { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1); z-index: 5; display: flex; align-items: center; justify-content: center; padding: 0 10px; gap: 6px; overflow-x: auto; }
        .day-btn { background-color: #e9ecef; border: 2px solid transparent; border-radius: 20px; padding: 10px 18px; font-size: 1em; font-weight: 500; color: #343a40; cursor: pointer; transition: all 0.25s ease; white-space: nowrap; flex-shrink: 0; }
        .day-btn:hover { background-color: #ced4da; }
        .day-btn.active { background-color: var(--primary-color); color: white; border-color: #303f9f; }
        .ai-btn { background-color: #ffc107; color: #333; } .locate-btn { background-color: #17a2b8; color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: #fff; padding: 25px 30px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }
        .modal-content h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; }
        .modal-actions { text-align: right; margin-top: 20px; }
        .modal-actions button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; }
        .modal-actions .btn-primary { background-color: var(--accent-color); color: white; }
        .modal-actions .btn-secondary { background-color: #6c757d; color: white; margin-left: 10px; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .main-container { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="itinerary-column">
            <div id="itinerary-header">
                <h2 id="day-title"></h2>
                <div id="trip-id-container" style="display: none;">è¡Œç¨‹ID: <code id="trip-id-display" title="é»æ“Šè¤‡è£½"></code></div>
            </div>
            <ul id="itinerary-list"></ul>
            <button id="add-item-btn" class="add-item-btn" style="display: none;">+ æ–°å¢åœ°é»</button>
        </div>
        <div id="map-column"><div id="map"></div></div>
    </div>
    <div id="day-selector"></div>

    <!-- Modals -->
    <div id="trip-modal" class="modal-overlay show">
        <div class="modal-content">
            <h2>æ­¡è¿ä½¿ç”¨é›²ç«¯æ—…éŠç®¡å®¶</h2>
            <p>æ‚¨å¯ä»¥å»ºç«‹ä¸€å€‹æ–°è¡Œç¨‹ï¼Œæˆ–è¼¸å…¥æœ‹å‹åˆ†äº«çš„è¡Œç¨‹IDä¾†åŠ å…¥å…±åŒç·¨è¼¯ã€‚</p>
            <div class="modal-actions" style="text-align: center;">
                <button id="create-trip-btn" class="btn-primary">å»ºç«‹æ–°è¡Œç¨‹</button>
                <button id="join-trip-btn" class="btn-secondary">åŠ å…¥è¡Œç¨‹</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="edit-modal-title">ç·¨è¼¯åœ°é»</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-item-id">
                <div class="form-group">
                    <label for="edit-time">æ™‚é–“ (ä¾‹å¦‚: 09:30~11:00)</label>
                    <input type="text" id="edit-time" required>
                </div>
                <div class="form-group">
                    <label for="edit-location-name">åœ°é»åç¨± (ä¾‹å¦‚: æ±äº¬éµå¡”)</label>
                    <input type="text" id="edit-location-name" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="edit-modal-cancel" class="btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    <div id="ai-modal" class="modal-overlay">
         <div class="modal-content">
            <button id="modal-close-btn" class="btn-secondary" style="position:absolute; top:15px; right:15px; width:30px; height:30px; border-radius:50%; padding:0; line-height:1;">&times;</button>
            <h2>âœ¨ AI æ—…éŠè¦åŠƒå¸«å»ºè­°</h2>
            <div id="ai-modal-body"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://maps.googleapis.com/maps/api/js?key=%VITE_GOOGLE_MAPS_API_KEY%&libraries=marker&callback=initApp" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- å…¨åŸŸè®Šæ•¸ ---
        let map, db, currentTripId, currentDay = 1, currentItinerary = {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- åˆå§‹åŒ– ---
        window.initApp = function() {
            try {
                const firebaseConfig = JSON.parse('%VITE_FIREBASE_CONFIG%');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase è¨­å®šç„¡æ•ˆï¼Œè«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ã€‚", e);
                alert("Firebase è¨­å®šç„¡æ•ˆï¼Œæ‡‰ç”¨ç¨‹å¼ç„¡æ³•å•Ÿå‹•ã€‚");
                return;
            }
            initMap();
            setupEventListeners();
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 35.6895, lng: 139.6917 }, zoom: 11,
                mapTypeControl: false, streetViewControl: false
            });
        }
        
        function setupEventListeners() {
            document.getElementById('create-trip-btn').addEventListener('click', createNewTrip);
            document.getElementById('join-trip-btn').addEventListener('click', joinTrip);
            document.getElementById('trip-id-display').addEventListener('click', () => navigator.clipboard.writeText(currentTripId));
            document.getElementById('add-item-btn').addEventListener('click', () => openEditModal(null));
            document.getElementById('edit-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('edit-modal-cancel').addEventListener('click', () => document.getElementById('edit-modal').classList.remove('show'));
        }

        // --- è¡Œç¨‹ç®¡ç† (Create/Join) ---
        async function createNewTrip() {
            const tripId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const defaultTripData = {
                title: "æˆ‘çš„æ±äº¬ä¹‹æ—…",
                days: Array.from({ length: 10 }, (_, i) => ({ day: i + 1, locations: [] }))
            };
            // æ›¿æ›ç‚ºä½¿ç”¨ public è·¯å¾‘
            const tripRef = doc(db, 'artifacts', appId, 'public/data/trips', tripId);
            await setDoc(tripRef, defaultTripData);
            loadTrip(tripId);
        }
        
        function joinTrip() {
            const tripId = prompt("è«‹è¼¸å…¥æœ‹å‹åˆ†äº«çš„è¡Œç¨‹ID:");
            if (tripId) {
                // æ›¿æ›ç‚ºä½¿ç”¨ public è·¯å¾‘
                const tripRef = doc(db, 'artifacts', appId, 'public/data/trips', tripId.trim());
                getDoc(tripRef).then(docSnap => {
                    if (docSnap.exists()) {
                        loadTrip(tripId.trim());
                    } else {
                        alert("æ‰¾ä¸åˆ°æ­¤è¡Œç¨‹IDï¼Œè«‹ç¢ºèªå¾Œå†è©¦ã€‚");
                    }
                });
            }
        }

        function loadTrip(tripId) {
            currentTripId = tripId;
            document.getElementById('trip-modal').classList.remove('show');
            document.getElementById('trip-id-container').style.display = 'block';
            document.getElementById('add-item-btn').style.display = 'block';
            document.getElementById('trip-id-display').textContent = tripId;
            
            // ç›£è½è¡Œç¨‹çš„å³æ™‚è®ŠåŒ–
            const tripRef = doc(db, 'artifacts', appId, 'public/data/trips', tripId);
            onSnapshot(tripRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentItinerary = docSnap.data();
                    renderUI();
                }
            });
            buildDaySelector();
        }

        // --- UI æ¸²æŸ“ ---
        function renderUI() {
            renderItineraryList();
            renderMapMarkers();
        }

        function buildDaySelector() {
            const daySelector = document.getElementById('day-selector');
            daySelector.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const button = document.createElement('button');
                button.className = 'day-btn';
                button.textContent = `ç¬¬ ${i} å¤©`;
                button.onclick = () => { currentDay = i; document.querySelectorAll('#day-selector .day-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); renderUI(); };
                daySelector.appendChild(button);
            }
             // è£œå› AI å’Œå®šä½æŒ‰éˆ•
            daySelector.innerHTML += `<button id="locate-me-btn" class="day-btn locate-btn">ğŸ“ å®šä½</button><button id="ai-planner-btn" class="day-btn ai-btn">âœ¨ AI å»ºè­°å¸«</button>`;
            document.getElementById('locate-me-btn').onclick = () => {}; // Placeholder
            document.getElementById('ai-planner-btn').onclick = () => {}; // Placeholder
            daySelector.querySelector('.day-btn').classList.add('active');
        }

        function renderItineraryList() {
            const listEl = document.getElementById('itinerary-list');
            const dayData = currentItinerary.days.find(d => d.day === currentDay);
            document.getElementById('day-title').textContent = `ç¬¬ ${currentDay} å¤©è¡Œç¨‹`;
            listEl.innerHTML = '';

            if (!dayData || dayData.locations.length === 0) return;

            dayData.locations.forEach(loc => {
                const itemEl = document.createElement('li');
                itemEl.className = 'itinerary-item';
                itemEl.dataset.id = loc.id;
                itemEl.innerHTML = `
                    <span class="drag-handle">â˜°</span>
                    <div class="item-content">
                        <div class="item-title">${loc.title}</div>
                        <div class="item-time">${loc.time}</div>
                    </div>
                    <div class="item-actions">
                        <button class="edit-btn" title="ç·¨è¼¯">âœï¸</button>
                        <button class="delete-btn" title="åˆªé™¤">ğŸ—‘ï¸</button>
                    </div>
                `;
                itemEl.querySelector('.edit-btn').onclick = () => openEditModal(loc.id);
                itemEl.querySelector('.delete-btn').onclick = () => deleteLocation(loc.id);
                listEl.appendChild(itemEl);
            });
            
            // åˆå§‹åŒ–æ‹–æ›³æ’åº
            new Sortable(listEl, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: async function (evt) {
                    const newOrderIds = Array.from(evt.to.children).map(item => item.dataset.id);
                    const dayData = currentItinerary.days.find(d => d.day === currentDay);
                    dayData.locations.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                    await updateFirestore();
                },
            });
        }
        
        function renderMapMarkers() { /* ... */ }

        // --- è³‡æ–™æ“ä½œ (CUD) ---
        function openEditModal(locationId) {
            const modal = document.getElementById('edit-modal');
            const form = document.getElementById('edit-form');
            form.reset();

            if (locationId) {
                const dayData = currentItinerary.days.find(d => d.day === currentDay);
                const location = dayData.locations.find(l => l.id === locationId);
                document.getElementById('edit-modal-title').textContent = 'ç·¨è¼¯åœ°é»';
                document.getElementById('edit-item-id').value = locationId;
                document.getElementById('edit-time').value = location.time;
                document.getElementById('edit-location-name').value = location.title;
            } else {
                document.getElementById('edit-modal-title').textContent = 'æ–°å¢åœ°é»';
                document.getElementById('edit-item-id').value = '';
            }
            modal.classList.add('show');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const locationName = document.getElementById('edit-location-name').value;
            const time = document.getElementById('edit-time').value;
            const locationId = document.getElementById('edit-item-id').value;

            // ä½¿ç”¨ Geocoding API
            const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(locationName)}&key=%VITE_GOOGLE_MAPS_API_KEY%`;
            try {
                const response = await fetch(geocodeUrl);
                const data = await response.json();
                if (data.status !== 'OK') throw new Error('æ‰¾ä¸åˆ°åœ°é»åº§æ¨™');
                
                const { lat, lng } = data.results[0].geometry.location;
                const dayData = currentItinerary.days.find(d => d.day === currentDay);

                if (locationId) { // ç·¨è¼¯
                    const loc = dayData.locations.find(l => l.id === locationId);
                    loc.title = locationName;
                    loc.time = time;
                    loc.lat = lat;
                    loc.lng = lng;
                } else { // æ–°å¢
                    dayData.locations.push({ id: Date.now().toString(), title: locationName, time: time, lat: lat, lng: lng });
                }
                await updateFirestore();
                document.getElementById('edit-modal').classList.remove('show');

            } catch(error) {
                console.error("Geocoding Error:", error);
                alert("ç„¡æ³•æ‰¾åˆ°è©²åœ°é»ï¼Œè«‹æª¢æŸ¥åç¨±å¾Œå†è©¦ä¸€æ¬¡ã€‚");
            }
        }

        async function deleteLocation(locationId) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹åœ°é»å—ï¼Ÿ")) return;
            const dayData = currentItinerary.days.find(d => d.day === currentDay);
            dayData.locations = dayData.locations.filter(l => l.id !== locationId);
            await updateFirestore();
        }
        
        async function updateFirestore() {
            const tripRef = doc(db, 'artifacts', appId, 'public/data/trips', currentTripId);
            await setDoc(tripRef, currentItinerary);
        }

    </script>
</body>
</html>
